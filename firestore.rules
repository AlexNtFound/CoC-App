// firestore.rules - æ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // æ´»åŠ¨é›†åˆè§„åˆ™
    match /events/{eventId} {
      // æ‰€æœ‰äººéƒ½å¯ä»¥è¯»å–å·²å‘å¸ƒçš„æ´»åŠ¨
      allow read: if resource.data.isPublished == true;
      
      // åªæœ‰è®¤è¯ç”¨æˆ·å¯ä»¥åˆ›å»ºæ´»åŠ¨
      allow create: if request.auth != null 
                    && request.auth.uid == resource.data.organizerId
                    && validateEventData(request.resource.data);
      
      // åªæœ‰åˆ›å»ºè€…å¯ä»¥æ›´æ–°å’Œåˆ é™¤è‡ªå·±çš„æ´»åŠ¨
      allow update, delete: if request.auth != null 
                           && request.auth.uid == resource.data.organizerId;
      
      // å…è®¸ç”¨æˆ·æ›´æ–°å‚ä¸è€…åˆ—è¡¨ï¼ˆRSVPåŠŸèƒ½ï¼‰
      allow update: if request.auth != null
                    && onlyUpdatingAttendees(request.resource.data, resource.data);
    }
    
    // ç”¨æˆ·èµ„æ–™é›†åˆè§„åˆ™ (å¯é€‰)
    match /users/{userId} {
      // ç”¨æˆ·åªèƒ½è¯»å†™è‡ªå·±çš„èµ„æ–™
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    
    // å…¬å‘Šé›†åˆè§„åˆ™ (å¯é€‰)
    match /announcements/{announcementId} {
      // æ‰€æœ‰äººéƒ½å¯ä»¥è¯»å–å…¬å‘Š
      allow read: if true;
      
      // åªæœ‰ç®¡ç†å‘˜å¯ä»¥åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤å…¬å‘Š
      allow create, update, delete: if request.auth != null 
                                    && isAdmin(request.auth.uid);
    }
  }
  
  // éªŒè¯æ´»åŠ¨æ•°æ®çš„å®Œæ•´æ€§
  function validateEventData(data) {
    return data.keys().hasAll(['title', 'description', 'date', 'time', 'location', 'organizer', 'organizerId', 'category']) &&
           data.title is string && data.title.size() > 0 &&
           data.description is string &&
           data.date is string &&
           data.time is string &&
           data.location is string && data.location.size() > 0 &&
           data.organizer is string && data.organizer.size() > 0 &&
           data.organizerId is string &&
           data.category in ['worship', 'study', 'fellowship', 'blending', 'prayer'] &&
           data.attendees is list &&
           data.waitingList is list &&
           data.isPublished is bool;
  }
  
  // æ£€æŸ¥æ˜¯å¦åªæ›´æ–°å‚ä¸è€…ç›¸å…³å­—æ®µ
  function onlyUpdatingAttendees(newData, oldData) {
    return newData.diff(oldData).affectedKeys().hasOnly(['attendees', 'waitingList', 'attendeeCount', 'waitingListCount', 'updatedAt']);
  }
  
  // æ£€æŸ¥æ˜¯å¦æ˜¯ç®¡ç†å‘˜ (è¿™é‡Œéœ€è¦æ ¹æ®ä½ çš„ç”¨æˆ·è§’è‰²ç³»ç»Ÿè°ƒæ•´)
  function isAdmin(userId) {
    // ç®€å•å®ç°ï¼šæ£€æŸ¥ç”¨æˆ·æ–‡æ¡£ä¸­çš„è§’è‰²
    return get(/databases/$(database)/documents/users/$(userId)).data.role == 'admin';
    
    // æˆ–è€…ç¡¬ç¼–ç ç®¡ç†å‘˜IDï¼ˆç”¨äºå¿«é€Ÿæµ‹è¯•ï¼‰
    // return userId in ['admin-user-id-1', 'admin-user-id-2'];
  }
}

/*
ğŸ”’ å®‰å…¨è§„åˆ™è¯´æ˜ï¼š

1. è¯»å–æƒé™ï¼šæ‰€æœ‰äººéƒ½å¯ä»¥è¯»å–å·²å‘å¸ƒçš„æ´»åŠ¨
2. åˆ›å»ºæƒé™ï¼šè®¤è¯ç”¨æˆ·å¯ä»¥åˆ›å»ºæ´»åŠ¨ï¼Œä½†å¿…é¡»æ˜¯æ´»åŠ¨çš„ç»„ç»‡è€…
3. æ›´æ–°/åˆ é™¤æƒé™ï¼šåªæœ‰æ´»åŠ¨åˆ›å»ºè€…å¯ä»¥ä¿®æ”¹æˆ–åˆ é™¤è‡ªå·±çš„æ´»åŠ¨
4. RSVPæƒé™ï¼šè®¤è¯ç”¨æˆ·å¯ä»¥æ›´æ–°å‚ä¸è€…åˆ—è¡¨ï¼ˆåŠ å…¥/é€€å‡ºæ´»åŠ¨ï¼‰
5. æ•°æ®éªŒè¯ï¼šç¡®ä¿æ´»åŠ¨æ•°æ®åŒ…å«å¿…è¦å­—æ®µä¸”æ ¼å¼æ­£ç¡®

ğŸš€ éƒ¨ç½²è§„åˆ™ï¼š
1. å®‰è£… Firebase CLI: npm install -g firebase-tools
2. ç™»å½•: firebase login
3. åˆå§‹åŒ–é¡¹ç›®: firebase init firestore
4. éƒ¨ç½²è§„åˆ™: firebase deploy --only firestore:rules

âš ï¸ æ³¨æ„äº‹é¡¹ï¼š
- è§„åˆ™éƒ¨ç½²åéœ€è¦å‡ åˆ†é’Ÿç”Ÿæ•ˆ
- å»ºè®®å…ˆåœ¨Firebaseæ§åˆ¶å°çš„Rules Playgroundä¸­æµ‹è¯•
- ç”Ÿäº§ç¯å¢ƒå‰åŠ¡å¿…å……åˆ†æµ‹è¯•æ‰€æœ‰æƒé™åœºæ™¯
*/