// CoC-App/components/InitialSetupScreen.tsx
import AsyncStorage from '@react-native-async-storage/async-storage';
import React, { useState } from 'react';
import {
    Dimensions,
    Image,
    Modal,
    ScrollView,
    StyleSheet,
    TouchableOpacity,
    View,
} from 'react-native';
import { useSafeAreaInsets } from 'react-native-safe-area-context';
import type { Language } from '../contexts/LanguageContext';
import { useLanguage } from '../contexts/LanguageContext';
import { useTheme } from '../contexts/ThemeContext';
import { useThemeColor } from '../hooks/useThemeColor';
import { ThemedText } from './ThemedText';
import { ThemedView } from './ThemedView';

const { width: screenWidth } = Dimensions.get('window');

interface InitialSetupScreenProps {
  visible: boolean;
  onComplete: () => void;
}

type ThemeMode = 'light' | 'dark' | 'system';

const SETUP_COMPLETE_KEY = 'initial_setup_complete';

export default function InitialSetupScreen({ visible, onComplete }: InitialSetupScreenProps) {
  const { language, setLanguage, t } = useLanguage();
  const { themeMode, setThemeMode, isDark } = useTheme();
  const insets = useSafeAreaInsets();
  
  const [selectedLanguage, setSelectedLanguage] = useState<Language>(language);
  const [selectedTheme, setSelectedTheme] = useState<ThemeMode>(themeMode);
  const [currentStep, setCurrentStep] = useState(0);
  
  const backgroundColor = useThemeColor({}, 'background');
  const cardBackground = useThemeColor({}, 'background');
  const borderColor = useThemeColor({}, 'icon');
  const accentColor = useThemeColor({}, 'tint');

  // Ê†πÊçÆÂΩìÂâç‰∏ªÈ¢òÈÄâÊã©logo
  const logoSource = isDark 
    ? require('../assets/images/adaptive-icon.png')
    : require('../assets/images/icon.png');

  const steps = [
    {
      id: 'welcome',
      title: 'Welcome to Christians on Campus!',
      titleZh: 'Ê¨¢ËøéÊù•Âà∞Ê†°Âõ≠Âü∫Áù£ÂæíÔºÅ',
      subtitle: 'Let\'s set up your experience',
      subtitleZh: 'ËÆ©Êàë‰ª¨ËÆæÁΩÆÊÇ®ÁöÑ‰ΩìÈ™å',
    },
    {
      id: 'language',
      title: 'Choose Your Language',
      titleZh: 'ÈÄâÊã©ÊÇ®ÁöÑËØ≠Ë®Ä',
      subtitle: 'Select your preferred language',
      subtitleZh: 'ÈÄâÊã©ÊÇ®ÂÅèÂ•ΩÁöÑËØ≠Ë®Ä',
    },
    {
      id: 'theme',
      title: 'Choose Your Theme',
      titleZh: 'ÈÄâÊã©ÊÇ®ÁöÑ‰∏ªÈ¢ò',
      subtitle: 'Select your preferred appearance',
      subtitleZh: 'ÈÄâÊã©ÊÇ®ÂÅèÂ•ΩÁöÑÂ§ñËßÇ',
    },
  ];

  const languageOptions = [
    {
      key: 'en' as Language,
      title: 'English',
      subtitle: 'Use English interface',
      icon: 'üá∫üá∏',
    },
    {
      key: 'zh' as Language,
      title: '‰∏≠Êñá',
      subtitle: '‰ΩøÁî®‰∏≠ÊñáÁïåÈù¢',
      icon: 'üá®üá≥',
    },
  ];

  const themeOptions = [
    {
      key: 'system' as ThemeMode,
      title: 'Follow System',
      titleZh: 'Ë∑üÈöèÁ≥ªÁªü',
      subtitle: 'Automatically match your device settings',
      subtitleZh: 'Ëá™Âä®ÂåπÈÖçÊÇ®ÁöÑËÆæÂ§áËÆæÁΩÆ',
      icon: 'üì±',
    },
    {
      key: 'light' as ThemeMode,
      title: 'Light Theme',
      titleZh: 'ÊµÖËâ≤‰∏ªÈ¢ò',
      subtitle: 'Use light appearance',
      subtitleZh: '‰ΩøÁî®ÊµÖËâ≤Â§ñËßÇ',
      icon: '‚òÄÔ∏è',
    },
    {
      key: 'dark' as ThemeMode,
      title: 'Dark Theme',
      titleZh: 'Ê∑±Ëâ≤‰∏ªÈ¢ò',
      subtitle: 'Use dark appearance',
      subtitleZh: '‰ΩøÁî®Ê∑±Ëâ≤Â§ñËßÇ',
      icon: 'üåô',
    },
  ];

  const handleNext = () => {
    // Language is already applied in handleLanguageSelection
    // Theme is already applied in handleThemeSelection
    
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1);
    } else {
      handleComplete();
    }
  };

  const handleBack = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1);
    }
  };

  const handleComplete = async () => {
    try {
      // Final theme setting is already applied in handleThemeSelection
      // Just mark setup as complete
      await AsyncStorage.setItem(SETUP_COMPLETE_KEY, 'true');
      
      onComplete();
    } catch (error) {
      console.error('Error saving initial setup:', error);
      // Still complete the setup even if saving fails
      onComplete();
    }
  };

  const handleSkip = async () => {
    try {
      // Mark setup as complete without changing settings
      await AsyncStorage.setItem(SETUP_COMPLETE_KEY, 'true');
      onComplete();
    } catch (error) {
      console.error('Error saving initial setup:', error);
      onComplete();
    }
  };

  const getCurrentTitle = () => {
    const step = steps[currentStep];
    return selectedLanguage === 'zh' ? step.titleZh : step.title;
  };

  const getCurrentSubtitle = () => {
    const step = steps[currentStep];
    return selectedLanguage === 'zh' ? step.subtitleZh : step.subtitle;
  };

  const getButtonText = (key: string) => {
    if (selectedLanguage === 'zh') {
      switch (key) {
        case 'next': return '‰∏ã‰∏ÄÊ≠•';
        case 'back': return 'ËøîÂõû';
        case 'complete': return 'ÂÆåÊàê';
        case 'skip': return 'Ë∑≥Ëøá';
        default: return key;
      }
    } else {
      switch (key) {
        case 'next': return 'Next';
        case 'back': return 'Back';
        case 'complete': return 'Complete';
        case 'skip': return 'Skip';
        default: return key;
      }
    }
  };

  const renderWelcomeStep = () => (
    <View style={styles.welcomeStepContent}>
      <View style={styles.welcomeContainer}>
        <Image source={logoSource} style={styles.welcomeLogo} />
        <ThemedText style={styles.stepTitle}>{getCurrentTitle()}</ThemedText>
        <ThemedText style={styles.stepSubtitle}>{getCurrentSubtitle()}</ThemedText>
        
        {/* <View style={styles.featureList}>
          <View style={styles.featureItem}>
            <ThemedText style={styles.featureIcon}>üìñ</ThemedText>
            <ThemedText style={styles.featureText}>
              {selectedLanguage === 'zh' ? 'ÈòÖËØªÂú£Áªè' : 'Read Bible'}
            </ThemedText>
          </View>
          <View style={styles.featureItem}>
            <ThemedText style={styles.featureIcon}>üìÖ</ThemedText>
            <ThemedText style={styles.featureText}>
              {selectedLanguage === 'zh' ? 'ÂèÇÂä†Ê¥ªÂä®' : 'Join Events'}
            </ThemedText>
          </View>
          <View style={styles.featureItem}>
            <ThemedText style={styles.featureIcon}>ü§ù</ThemedText>
            <ThemedText style={styles.featureText}>
              {selectedLanguage === 'zh' ? 'ÂºüÂÖÑÂßäÂ¶π‰∫§ÈÄö' : 'Fellowship'}
            </ThemedText>
          </View>
        </View> */}
      </View>
    </View>
  );

  const handleLanguageSelection = async (lang: Language) => {
    setSelectedLanguage(lang);
    // Á´ãÂç≥Â∫îÁî®ËØ≠Ë®ÄÂèòÂåñÔºåËøôÊ†∑Áî®Êà∑ÂèØ‰ª•ÁúãÂà∞ÂÆûÊó∂È¢ÑËßà
    try {
      await setLanguage(lang);
    } catch (error) {
      console.error('Error applying language:', error);
    }
  };

  const renderLanguageStep = () => (
    <View style={styles.stepContent}>
      <ThemedText style={styles.stepTitle}>{getCurrentTitle()}</ThemedText>
      <ThemedText style={styles.stepSubtitle}>{getCurrentSubtitle()}</ThemedText>
      
      <View style={styles.optionsContainer}>
        {languageOptions.map((option) => (
          <TouchableOpacity
            key={option.key}
            style={[
              styles.optionButton,
              { backgroundColor: cardBackground, borderColor },
              selectedLanguage === option.key && { 
                backgroundColor: accentColor + '20', 
                borderColor: accentColor 
              }
            ]}
            onPress={() => handleLanguageSelection(option.key)}
          >
            <ThemedText style={styles.optionIcon}>{option.icon}</ThemedText>
            <View style={styles.optionText}>
              <ThemedText style={[
                styles.optionTitle,
                selectedLanguage === option.key && { color: accentColor }
              ]}>
                {option.title}
              </ThemedText>
              <ThemedText style={styles.optionSubtitle}>{option.subtitle}</ThemedText>
            </View>
            {selectedLanguage === option.key && (
              <ThemedText style={[styles.checkmark, { color: accentColor }]}>‚úì</ThemedText>
            )}
          </TouchableOpacity>
        ))}
      </View>
    </View>
  );

  const handleThemeSelection = async (theme: ThemeMode) => {
    setSelectedTheme(theme);
    // Á´ãÂç≥Â∫îÁî®‰∏ªÈ¢òÂèòÂåñÔºåËøôÊ†∑Áî®Êà∑ÂèØ‰ª•ÁúãÂà∞ÂÆûÊó∂È¢ÑËßà
    try {
      await setThemeMode(theme);
    } catch (error) {
      console.error('Error applying theme:', error);
    }
  };

  const renderThemeStep = () => (
    <View style={styles.stepContent}>
      <ThemedText style={styles.stepTitle}>{getCurrentTitle()}</ThemedText>
      <ThemedText style={styles.stepSubtitle}>{getCurrentSubtitle()}</ThemedText>
      
      <View style={styles.optionsContainer}>
        {themeOptions.map((option) => (
          <TouchableOpacity
            key={option.key}
            style={[
              styles.optionButton,
              { backgroundColor: cardBackground, borderColor },
              selectedTheme === option.key && { 
                backgroundColor: accentColor + '20', 
                borderColor: accentColor 
              }
            ]}
            onPress={() => handleThemeSelection(option.key)}
          >
            <ThemedText style={styles.optionIcon}>{option.icon}</ThemedText>
            <View style={styles.optionText}>
              <ThemedText style={[
                styles.optionTitle,
                selectedTheme === option.key && { color: accentColor }
              ]}>
                {selectedLanguage === 'zh' ? option.titleZh : option.title}
              </ThemedText>
              <ThemedText style={styles.optionSubtitle}>
                {selectedLanguage === 'zh' ? option.subtitleZh : option.subtitle}
              </ThemedText>
            </View>
            {selectedTheme === option.key && (
              <ThemedText style={[styles.checkmark, { color: accentColor }]}>‚úì</ThemedText>
            )}
          </TouchableOpacity>
        ))}
      </View>
    </View>
  );

  const renderStepContent = () => {
    switch (currentStep) {
      case 0:
        return renderWelcomeStep();
      case 1:
        return renderLanguageStep();
      case 2:
        return renderThemeStep();
      default:
        return renderWelcomeStep();
    }
  };

  return (
    <Modal
      visible={visible}
      animationType="fade"
      presentationStyle="fullScreen"
    >
      <ThemedView style={[styles.container, { backgroundColor }]}>
        <View style={[styles.content, { paddingTop: insets.top + 20 }]}>
          {/* Progress Indicator */}
          <View style={styles.progressContainer}>
            {steps.map((_, index) => (
              <View
                key={index}
                style={[
                  styles.progressDot,
                  { backgroundColor: borderColor },
                  index <= currentStep && { backgroundColor: accentColor }
                ]}
              />
            ))}
          </View>

          {/* Step Content */}
          <ScrollView 
            style={styles.scrollView}
            contentContainerStyle={styles.scrollContent}
            showsVerticalScrollIndicator={false}
          >
            {renderStepContent()}
          </ScrollView>

          {/* Navigation Buttons */}
          <View style={[styles.buttonContainer, { paddingBottom: insets.bottom }]}>
            <View style={styles.buttonRow}>
              {currentStep > 0 ? (
                <TouchableOpacity
                  style={[styles.button, styles.backButton, { borderColor }]}
                  onPress={handleBack}
                >
                  <ThemedText style={styles.backButtonText}>
                    {getButtonText('back')}
                  </ThemedText>
                </TouchableOpacity>
              ) : (
                <TouchableOpacity
                  style={[styles.button, styles.skipButton]}
                  onPress={handleSkip}
                >
                  <ThemedText style={styles.skipButtonText}>
                    {getButtonText('skip')}
                  </ThemedText>
                </TouchableOpacity>
              )}

              <TouchableOpacity
                style={[styles.button, styles.nextButton, { backgroundColor: accentColor }]}
                onPress={handleNext}
              >
                <ThemedText style={styles.nextButtonText}>
                  {currentStep === steps.length - 1 ? getButtonText('complete') : getButtonText('next')}
                </ThemedText>
              </TouchableOpacity>
            </View>
          </View>
        </View>
      </ThemedView>
    </Modal>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  content: {
    flex: 1,
    paddingHorizontal: 24,
    paddingVertical: 10, // Ê∑ªÂä†ÂûÇÁõ¥paddingÁ°Æ‰øùÂÜÖÂÆπ‰∏çË¢´Ë£ÅÂâ™
  },
  progressContainer: {
    flexDirection: 'row',
    justifyContent: 'center',
    alignItems: 'center',
    marginBottom: 40,
    gap: 8,
    paddingVertical: 10, // Ê∑ªÂä†ÂûÇÁõ¥padding
  },
  progressDot: {
    width: 8,
    height: 8,
    borderRadius: 4,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    flexGrow: 1,
    paddingBottom: 20,
    paddingTop: 10, // Ê∑ªÂä†È°∂ÈÉ®paddingÈò≤Ê≠¢ÂÜÖÂÆπË¢´Ë£ÅÂâ™
  },
  stepContent: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'flex-start', // ‰øùÊåÅÁ¨¨2„ÄÅ3È°µ‰ªéÈ°∂ÈÉ®ÂºÄÂßã
    minHeight: 400,
    paddingVertical: 20,
    paddingTop: 40,
  },
  // ‰∏ìÈó®‰∏∫Á¨¨‰∏ÄÈ°µÔºàÊ¨¢ËøéÈ°µÔºâÂàõÂª∫ÁöÑÊ†∑Âºè
  welcomeStepContent: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center', // Á¨¨‰∏ÄÈ°µÂ±Ö‰∏≠ÂØπÈΩê
    minHeight: 400,
    paddingVertical: 20,
  },
  welcomeContainer: {
    alignItems: 'center',
    paddingHorizontal: 20,
    paddingVertical: 20, // ÊÅ¢Â§çÁ¨¨‰∏ÄÈ°µÁöÑÂûÇÁõ¥padding
  },
  welcomeLogo: {
    width: 280,
    height: 280,
    resizeMode: 'contain',
    marginBottom: 48, // ÊÅ¢Â§çÁ¨¨‰∏ÄÈ°µÁöÑËæÉÂ§ßËæπË∑ù
  },
  stepTitle: {
    fontSize: 28,
    fontWeight: 'bold',
    textAlign: 'center',
    marginBottom: 12,
    lineHeight: 36, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
    paddingHorizontal: 10, // Ê∑ªÂä†Ê∞¥Âπ≥padding
  },
  stepSubtitle: {
    fontSize: 16,
    opacity: 0.7,
    textAlign: 'center',
    marginBottom: 40, // ÊÅ¢Â§çÁ¨¨‰∏ÄÈ°µÁöÑËæÉÂ§ßËæπË∑ù
    lineHeight: 24,
    paddingHorizontal: 10,
  },
  featureList: {
    gap: 20,
    alignItems: 'flex-start',
    paddingVertical: 10, // Ê∑ªÂä†ÂûÇÁõ¥padding
  },
  featureItem: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
    paddingVertical: 4, // Ê∑ªÂä†ÂûÇÁõ¥paddingÈò≤Ê≠¢Ë£ÅÂâ™
  },
  featureIcon: {
    fontSize: 24,
    lineHeight: 30, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
    textAlign: 'center',
    minWidth: 30, // Á°Æ‰øùÊúâË∂≥Â§üÁ©∫Èó¥
  },
  featureText: {
    fontSize: 16,
    fontWeight: '500',
    lineHeight: 24, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
    flex: 1,
  },
  optionsContainer: {
    width: '100%',
    gap: 12,
    marginTop: 20,
    paddingHorizontal: 4, // Ê∑ªÂä†Ê∞¥Âπ≥paddingÈò≤Ê≠¢ËæπÁºòË£ÅÂâ™
  },
  optionButton: {
    flexDirection: 'row',
    alignItems: 'center',
    padding: 16,
    borderRadius: 12,
    borderWidth: 2,
    minHeight: 70, // Á°Æ‰øùÊúâË∂≥Â§üÈ´òÂ∫¶
  },
  optionIcon: {
    fontSize: 24,
    marginRight: 16,
    lineHeight: 30, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
    textAlign: 'center',
    minWidth: 30, // Á°Æ‰øùÊúâË∂≥Â§üÁ©∫Èó¥
  },
  optionText: {
    flex: 1,
    paddingVertical: 4, // Ê∑ªÂä†ÂûÇÁõ¥padding
  },
  optionTitle: {
    fontSize: 16,
    fontWeight: '600',
    marginBottom: 2,
    lineHeight: 22, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
  },
  optionSubtitle: {
    fontSize: 14,
    opacity: 0.6,
    lineHeight: 20, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
  },
  checkmark: {
    fontSize: 20,
    fontWeight: 'bold',
    lineHeight: 24, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
    textAlign: 'center',
    minWidth: 24, // Á°Æ‰øùÊúâË∂≥Â§üÁ©∫Èó¥
  },
  buttonContainer: {
    paddingTop: 20,
    paddingHorizontal: 4, // Ê∑ªÂä†Ê∞¥Âπ≥paddingÈò≤Ê≠¢ËæπÁºòË£ÅÂâ™
  },
  buttonRow: {
    flexDirection: 'row',
    gap: 12,
  },
  button: {
    flex: 1,
    paddingVertical: 16,
    borderRadius: 12,
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: 52, // Á°Æ‰øùÊåâÈíÆÊúâË∂≥Â§üÈ´òÂ∫¶
  },
  backButton: {
    backgroundColor: 'transparent',
    borderWidth: 1,
  },
  skipButton: {
    backgroundColor: 'transparent',
  },
  nextButton: {
    // backgroundColor set dynamically
  },
  backButtonText: {
    fontSize: 16,
    fontWeight: '600',
    lineHeight: 20, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
  },
  skipButtonText: {
    fontSize: 16,
    fontWeight: '600',
    opacity: 0.6,
    lineHeight: 20, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
  },
  nextButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: 'white',
    lineHeight: 20, // Ê∑ªÂä†Ë°åÈ´òÈò≤Ê≠¢Ë£ÅÂâ™
  },
});

// Export utility function to check if setup is complete
export const checkSetupComplete = async (): Promise<boolean> => {
  try {
    const setupComplete = await AsyncStorage.getItem(SETUP_COMPLETE_KEY);
    return setupComplete === 'true';
  } catch (error) {
    console.error('Error checking setup status:', error);
    return false;
  }
};

// Export utility function to reset setup for development/testing
export const resetSetupForDevelopment = async (): Promise<void> => {
  try {
    await AsyncStorage.removeItem(SETUP_COMPLETE_KEY);
    console.log('üîß Development: Initial setup has been reset');
  } catch (error) {
    console.error('Error resetting setup status:', error);
  }
};